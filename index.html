<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sunset Sanctuary Drive</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            font-family: 'Arial', sans-serif;
            color: white;
        }
        canvas {
            display: block;
        }
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 10px;
            background: rgba(0,0,0,0.5);
            border-radius: 5px;
        }
        #drowsiness-container {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 10px;
            background: rgba(0,0,0,0.5);
            border-radius: 5px;
            width: 200px;
        }
        #drowsiness-bar {
            width: 100%;
            height: 20px;
            background-color: #555;
            border-radius: 3px;
            overflow: hidden;
        }
        #drowsiness-fill {
            height: 100%;
            width: 0%;
            background-color: #ffc107;
            transition: width 0.2s;
        }
        #vignette-effect {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            box-shadow: inset 0 0 0px rgba(0, 0, 0, 0);
            transition: box-shadow 0.5s ease-out;
        }
         #message-box {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #message-box h1 {
            font-size: 2.5em;
            margin-bottom: 20px;
        }
        #message-box p {
            font-size: 1.2em;
            margin-bottom: 30px;
            max-width: 500px;
        }
        #start-button {
            padding: 15px 30px;
            font-size: 1.5em;
            cursor: pointer;
            border: none;
            background-color: #4CAF50;
            color: white;
            border-radius: 8px;
            transition: background-color 0.3s;
        }
        #start-button:hover {
            background-color: #45a049;
        }
        #camera-flash {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            opacity: 0;
            pointer-events: none;
            z-index: 20;
        }
    </style>
</head>
<body>
    <div id="info">
        <div>Speed: <span id="speed">0</span> km/h</div>
        <div>Golden Deer Photos: <span id="photos">0</span> / 3</div>
    </div>
    <div id="drowsiness-container">
        <div>Drowsiness</div>
        <div id="drowsiness-bar">
            <div id="drowsiness-fill"></div>
        </div>
    </div>

    <div id="vignette-effect"></div>

    <div id="message-box">
        <h1>Sunset Sanctuary Drive</h1>
        <p>The sanctuary road is longer and more crowded than ever! Your mission is still to photograph 3 rare Golden Deer. Be extra careful, stay focused, and watch out for the increased wildlife. Drive using WASD, use SPACE to take photos.</p>
        <button id="start-button">Start Patrol</button>
    </div>

    <div id="camera-flash"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        let scene, camera, renderer, car;
        let speed = 0, acceleration = 0.01, deceleration = 0.005, maxSpeed = 1.5;
        let keys = { w: false, s: false, a: false, d: false };
        let trees = [], deer = [];
        let clock = new THREE.Clock();
        let carVelocity = new THREE.Vector3();

        let goldenDeerPhotos = 0;
        const speedElement = document.getElementById('speed');
        const photosElement = document.getElementById('photos');
        const drowsinessFill = document.getElementById('drowsiness-fill');
        const vignetteEffect = document.getElementById('vignette-effect');

        // Game constants
        const ROAD_WIDTH = 10;
        const ROAD_LENGTH = 2000;
        const TREE_COUNT = 300;
        const DEER_COUNT = 75;
        const GOLDEN_DEER_COUNT = 3;
        const CAR_SPEED = 0.7;
        const CAR_TURN_SPEED = 0.05;
        
        let gameRunning = false;

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87ceeb);
            scene.fog = new THREE.Fog(0x87ceeb, 100, 400);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);
            
            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
            scene.add(ambientLight);

            const dirLight = new THREE.DirectionalLight(0xffd57e, 1);
            dirLight.position.set(-60, 100, -10);
            dirLight.castShadow = true;
            dirLight.shadow.camera.top = 50;
            dirLight.shadow.camera.bottom = -50;
            dirLight.shadow.camera.left = -50;
            dirLight.shadow.camera.right = 50;
            dirLight.shadow.camera.near = 0.1;
            dirLight.shadow.camera.far = 200;
            scene.add(dirLight);

            car = createCar();
            scene.add(car);

            createRoad();
            createTrees();
            createAllDeer();

            camera.position.set(0, 5, 10);
            camera.lookAt(0, 0, 0);

            document.addEventListener('keydown', onKeyDown, false);
            document.addEventListener('keyup', onKeyUp, false);
            window.addEventListener('resize', onWindowResize, false);
            
            document.getElementById('start-button').addEventListener('click', () => {
                document.getElementById('message-box').style.display = 'none';
                gameRunning = true;
                animate();
            });
        }

        function createCar() {
            const carGroup = new THREE.Group();
            const carBody = new THREE.Mesh(
                new THREE.BoxGeometry(2, 1, 4),
                new THREE.MeshStandardMaterial({ color: 0xff0000 })
            );
            carBody.castShadow = true;
            carGroup.add(carBody);

            const carTop = new THREE.Mesh(
                new THREE.BoxGeometry(1.8, 0.8, 2.5),
                new THREE.MeshStandardMaterial({ color: 0xcccccc })
            );
            carTop.position.y = 0.9;
            carTop.position.z = -0.5;
            carGroup.add(carTop);
            
            carGroup.position.y = 0.5;
            return carGroup;
        }

        function createRoad() {
            const road = new THREE.Mesh(
                new THREE.PlaneGeometry(ROAD_WIDTH, ROAD_LENGTH),
                new THREE.MeshStandardMaterial({ color: 0x444444 })
            );
            road.rotation.x = -Math.PI / 2;
            road.position.z = -(ROAD_LENGTH / 2) + 20;
            road.receiveShadow = true;
            scene.add(road);
        }

        function createTrees() {
            for (let i = 0; i < TREE_COUNT; i++) {
                const tree = createTree();
                tree.position.z = -(Math.random() * ROAD_LENGTH);
                const side = Math.random() < 0.5 ? -1 : 1;
                tree.position.x = side * (ROAD_WIDTH / 2 + 5 + Math.random() * 20);
                scene.add(tree);
                trees.push(tree);
            }
        }

        function createTree() {
            const trunkHeight = Math.random() * 5 + 5;
            const trunk = new THREE.Mesh(
                new THREE.CylinderGeometry(0.5, 0.5, trunkHeight, 8),
                new THREE.MeshStandardMaterial({ color: 0x8B4513 })
            );
            trunk.position.y = trunkHeight / 2;
            trunk.castShadow = true;

            const foliage = new THREE.Mesh(
                new THREE.DodecahedronGeometry(3),
                new THREE.MeshStandardMaterial({ color: 0x006400 })
            );
            foliage.position.y = trunkHeight + 2;
            foliage.castShadow = true;
            
            const treeGroup = new THREE.Group();
            treeGroup.add(trunk);
            treeGroup.add(foliage);
            return treeGroup;
        }

        function createAllDeer() {
            const deerMaterial = new THREE.MeshStandardMaterial({ color: 0x8B4513 });
            const goldenMaterial = new THREE.MeshStandardMaterial({ color: 0xFFD700, emissive: 0xccad00 });

            for (let i = 0; i < DEER_COUNT; i++) {
                const d = createDeer(deerMaterial);
                resetDeer(d);
                scene.add(d);
                deer.push(d);
            }
            for (let i = 0; i < GOLDEN_DEER_COUNT; i++) {
                const d = createDeer(goldenMaterial);
                d.isGolden = true;
                resetDeer(d);
                scene.add(d);
                deer.push(d);
            }
        }

        function createDeer(material) {
            const bodyGeo = new THREE.BoxGeometry(1.5, 0.8, 0.6);
            const deerMesh = new THREE.Mesh(bodyGeo, material);
            deerMesh.castShadow = true;
            deerMesh.userData.speed = Math.random() * 0.07 + 0.04;
            deerMesh.userData.direction = Math.random() < 0.5 ? 1 : -1;
            return deerMesh;
        }

        function resetDeer(d) {
            d.position.z = car.position.z - 200 - Math.random() * (ROAD_LENGTH-200);
            const side = Math.random() < 0.5 ? -1 : 1;
            d.position.x = side * (ROAD_WIDTH / 2 + 2);
            d.userData.direction = -side; // move towards the road
            d.visible = true;
        }
        
        let drowsiness = 0;

        function updateCar(delta) {
            if (keys.w) {
                speed = Math.min(maxSpeed, speed + acceleration);
            } else {
                speed = Math.max(0, speed - deceleration);
            }
            if (keys.s) {
                speed = Math.max(-maxSpeed / 2, speed - acceleration * 1.5);
            }

            carVelocity.z = -speed * CAR_SPEED;
            
            if (keys.a) {
                car.rotation.y += CAR_TURN_SPEED;
            }
            if (keys.d) {
                car.rotation.y -= CAR_TURN_SPEED;
            }

            // Apply drowsiness sway
            const swayAngle = Math.sin(clock.getElapsedTime() * 2) * drowsiness * 0.015;
            car.rotation.y += swayAngle;
            
            const forward = new THREE.Vector3(0, 0, 1).applyQuaternion(car.quaternion);
            car.position.add(forward.multiplyScalar(-speed * CAR_SPEED));

            // Keep car on the road (y-axis)
            car.position.y = 0.5;
            
            // Check if car is off-road
            if (Math.abs(car.position.x) > ROAD_WIDTH / 2) {
                speed *= 0.95; // Slow down
                carVelocity.x = 0; // Stop sideways movement
                drowsiness = Math.min(1, drowsiness + 0.01);
            }

            // Update drowsiness
            drowsiness = Math.max(0, drowsiness - delta * 0.04);
            if(speed > 0) { // increase drowsiness while driving forward
                 drowsiness = Math.min(1, drowsiness + delta * 0.035);
            }
             updateDrowsinessUI();
        }

        function updateDrowsinessUI() {
            drowsinessFill.style.width = `${drowsiness * 100}%`;
            const shadowIntensity = drowsiness * 150;
            vignetteEffect.style.boxShadow = `inset 0 0 ${shadowIntensity}px rgba(0, 0, 0, ${drowsiness})`;
        }

        function updateCamera() {
            const relativeCameraOffset = new THREE.Vector3(0, 4, 8);
            const cameraOffset = relativeCameraOffset.applyMatrix4(car.matrixWorld);
            camera.position.x = cameraOffset.x;
            camera.position.y = cameraOffset.y;
            camera.position.z = cameraOffset.z;
            camera.lookAt(car.position);
        }

        function checkCollisions() {
            const carBox = new THREE.Box3().setFromObject(car);
            deer.forEach(d => {
                if (!d.visible) return;
                const deerBox = new THREE.Box3().setFromObject(d);
                const distance = car.position.distanceTo(d.position);
                
                if (carBox.intersectsBox(deerBox)) {
                    gameOver("You collided with a protected animal.");
                }

                // Make deer run away if car is too close
                if (distance < 15) {
                   const directionToCar = new THREE.Vector3().subVectors(d.position, car.position).normalize();
                   let runawaySpeed = d.isGolden ? 0.2 : 0.1;
                   d.position.add(directionToCar.multiplyScalar(runawaySpeed));
                }
            });
        }
        
        function onKeyDown(event) {
            switch (event.key.toLowerCase()) {
                case 'w': keys.w = true; break;
                case 's': keys.s = true; break;
                case 'a': keys.a = true; break;
                case 'd': keys.d = true; break;
                case ' ': takePhoto(); break;
            }
        }
        
        function onKeyUp(event) {
            switch (event.key.toLowerCase()) {
                case 'w': keys.w = false; break;
                case 's': keys.s = false; break;
                case 'a': keys.a = false; break;
                case 'd': keys.d = false; break;
            }
        }
        
        function takePhoto() {
            if (!gameRunning) return;
            const flash = document.getElementById('camera-flash');
            flash.style.opacity = 1;
            setTimeout(() => { flash.style.opacity = 0; }, 100);

            let photoMade = false;
            deer.forEach(d => {
                if (d.isGolden && d.visible) {
                    const distance = car.position.distanceTo(d.position);
                    if (distance < 30) {
                        const dir = new THREE.Vector3();
                        car.getWorldDirection(dir);
                        const deerDir = d.position.clone().sub(car.position).normalize();
                        const angle = dir.angleTo(deerDir);
                        if (angle < Math.PI / 4) {
                            d.visible = false;
                            goldenDeerPhotos++;
                            photoMade = true;
                        }
                    }
                }
            });

            if (photoMade) {
                // Immediately update the photo count display
                photosElement.textContent = `Golden Deer Photos: ${goldenDeerPhotos} / ${GOLDEN_DEER_COUNT}`;
                
                if (goldenDeerPhotos >= GOLDEN_DEER_COUNT) {
                    gameOver("Congratulations! You photographed all the golden deer!");
                }
            }
        }
        
        function updateWildlife() {
            deer.forEach(d => {
                if (!d.visible) return;
                d.position.x += d.userData.speed * d.userData.direction;
                if (Math.abs(d.position.x) > ROAD_WIDTH / 2 + 10) {
                    d.userData.direction *= -1;
                }
                if (d.position.z > car.position.z + 20) {
                    resetDeer(d);
                }
            });
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function gameOver(message) {
            gameRunning = false;
            const messageBox = document.getElementById('message-box');
            messageBox.querySelector('h1').textContent = "Patrol Over";
            messageBox.querySelector('p').textContent = message;
            const button = messageBox.querySelector('button');
            button.textContent = "Try Again";
            button.onclick = () => window.location.reload();
            messageBox.style.display = 'flex';
        }

        function animate() {
            if (!gameRunning) return;
            requestAnimationFrame(animate);
            const delta = clock.getDelta();
            
            updateCar(delta);
            updateCamera();
            updateWildlife();
            checkCollisions();
            
            speedElement.textContent = (Math.abs(speed) * 30).toFixed(0);

            renderer.render(scene, camera);
        }

        init();

    </script>
</body>
</html>

