<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gourmet 3D Intro Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; background-color: #0d0d0d; font-family: 'Inter', sans-serif; color: white; }
        canvas { display: block; }
        .ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 2rem;
            z-index: 10;
        }
        .controls {
            pointer-events: auto;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(12px);
            border-radius: 20px;
            padding: 1.5rem;
            width: 340px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            color: #1a1a1a;
        }
        .recording-pulse { animation: pulse 1.5s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.3; transform: scale(1.1); }
        }
        .hidden { display: none; }
        .btn-gourmet {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }
        .btn-gourmet:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4);
        }
    </style>
</head>
<body>

    <div id="container"></div>

    <div class="ui-overlay">
        <div class="flex justify-between items-start">
            <div>
                <h1 class="text-3xl font-serif font-bold tracking-tight text-white drop-shadow-2xl">
                    CulinaryStudio 3D
                </h1>
                <p class="text-[10px] text-green-400 uppercase tracking-[0.4em] font-bold mt-1">Advanced Brand Narratives</p>
            </div>
            
            <div id="recordingStatus" class="hidden flex items-center space-x-2 bg-red-600 px-4 py-1.5 rounded-full text-[10px] font-black tracking-widest text-white shadow-lg">
                <div class="w-2.5 h-2.5 bg-white rounded-full recording-pulse"></div>
                <span>LIVE CAPTURE</span>
            </div>
        </div>

        <div class="controls space-y-4">
            <div>
                <label class="block text-[11px] font-bold uppercase tracking-widest mb-2 text-gray-500">1. Product Image (Flat on Table)</label>
                <input type="file" id="productUpload" accept="image/*" class="block w-full text-[10px] text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-[10px] file:font-bold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer" />
            </div>

            <div>
                <label class="block text-[11px] font-bold uppercase tracking-widest mb-2 text-gray-500">2. Brand Identity (Transparent 3D Logo)</label>
                <input type="file" id="logoUpload" accept="image/*" class="block w-full text-[10px] text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-[10px] file:font-bold file:bg-green-50 file:text-green-700 hover:file:bg-green-100 cursor-pointer" />
            </div>

            <div class="space-y-2">
                <label class="block text-[11px] font-bold uppercase tracking-widest text-gray-500">Visual Aesthetic</label>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="setLighting('warm')" class="text-[10px] font-bold py-2 border border-gray-200 rounded-lg hover:bg-orange-50 transition-colors">ORGANIC WARM</button>
                    <button onclick="setLighting('clean')" class="text-[10px] font-bold py-2 border border-gray-200 rounded-lg hover:bg-blue-50 transition-colors">FRESH CLEAN</button>
                </div>
            </div>

            <div class="pt-1">
                <button id="recordBtn" class="w-full btn-gourmet font-bold text-xs uppercase tracking-widest py-3 rounded-xl flex items-center justify-center space-x-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M23 7l-7 5 7 5V7z"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>
                    <span>Download Video</span>
                </button>
            </div>
            
            <p class="text-[9px] text-gray-400 text-center leading-tight">Sequence: Kitchen &rarr; Healthy Foods &rarr; Final Reveal</p>
        </div>
    </div>

    <script>
        let scene, camera, renderer, clock;
        let logoPlaque, productMesh, logoGroup;
        let mainLight, rimLight, ambient;
        let foodItems = [];
        let mediaRecorder;
        let recordedChunks = [];

        const init = () => {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0a0a);
            scene.fog = new THREE.FogExp2(0x0a0a0a, 0.04);
            
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.shadowMap.enabled = true;
            
            if (renderer.outputEncoding !== undefined) {
                renderer.outputEncoding = THREE.sRGBEncoding;
            } else {
                renderer.outputColorSpace = THREE.SRGBColorSpace;
            }
            document.getElementById('container').appendChild(renderer.domElement);

            clock = new THREE.Clock();

            ambient = new THREE.AmbientLight(0xffffff, 0.7);
            scene.add(ambient);

            mainLight = new THREE.DirectionalLight(0xfff5e6, 1.2);
            mainLight.position.set(10, 20, 10);
            mainLight.castShadow = true;
            scene.add(mainLight);

            rimLight = new THREE.PointLight(0x2ecc71, 2, 30);
            rimLight.position.set(-10, 5, -15);
            scene.add(rimLight);

            buildKitchen();
            buildFoodSection();
            create3DLogoPlaque();

            bindFileListeners();
            
            window.addEventListener('resize', onWindowResize, false);
            animate();
        };

        const buildKitchen = () => {
            const counterMat = new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 0.1, metalness: 0.2 });
            const woodMat = new THREE.MeshStandardMaterial({ color: 0x3d2b1f, roughness: 0.9 });
            
            const island = new THREE.Mesh(new THREE.BoxGeometry(8, 2, 4), woodMat);
            island.position.set(0, -1, 10);
            island.receiveShadow = true;
            scene.add(island);

            const counterTop = new THREE.Mesh(new THREE.BoxGeometry(8.2, 0.15, 4.2), counterMat);
            counterTop.position.set(0, 0, 10);
            counterTop.receiveShadow = true;
            scene.add(counterTop);

            const productGeo = new THREE.PlaneGeometry(3, 3);
            const productMat = new THREE.MeshStandardMaterial({ 
                transparent: true, 
                opacity: 0, 
                side: THREE.DoubleSide,
                roughness: 0.4,
                alphaTest: 0.05
            });
            productMesh = new THREE.Mesh(productGeo, productMat);
            productMesh.rotation.x = -Math.PI / 2;
            productMesh.position.set(0, 0.08, 10); 
            productMesh.receiveShadow = true;
            scene.add(productMesh);

            const floor = new THREE.Mesh(
                new THREE.PlaneGeometry(100, 100),
                new THREE.MeshStandardMaterial({ color: 0x111111, roughness: 0.8 })
            );
            floor.rotation.x = -Math.PI/2;
            floor.position.y = -2;
            floor.receiveShadow = true;
            scene.add(floor);
        };

        const buildFoodSection = () => {
            const foodColors = [0xff4444, 0xffaa00, 0x22ff44, 0x99ff33, 0xff0088];
            const startZ = 0;
            const endZ = -25;
            
            for(let i = 0; i < 25; i++) {
                const type = Math.floor(Math.random() * 3);
                let geo;
                if(type === 0) geo = new THREE.SphereGeometry(0.4, 32, 32);
                else if(type === 1) geo = new THREE.IcosahedronGeometry(0.5, 0);
                else geo = new THREE.TorusGeometry(0.3, 0.15, 16, 100);

                const mat = new THREE.MeshStandardMaterial({ 
                    color: foodColors[Math.floor(Math.random() * foodColors.length)],
                    roughness: 0.3,
                    metalness: 0.1
                });
                
                const food = new THREE.Mesh(geo, mat);
                food.position.set(
                    (Math.random() - 0.5) * 10,
                    (Math.random() - 0.5) * 5 + 1,
                    THREE.MathUtils.lerp(startZ, endZ, i/25)
                );
                
                food.userData.rotSpeed = Math.random() * 0.02;
                foodItems.push(food);
                scene.add(food);
            }
        };

        const create3DLogoPlaque = () => {
            logoGroup = new THREE.Group();
            
            // To support transparency, we use a thinner box and enable transparency on all materials
            const plaqueGeo = new THREE.BoxGeometry(4, 2.5, 0.2);
            
            const sideMat = new THREE.MeshStandardMaterial({ 
                color: 0x222222, 
                metalness: 0.9, 
                roughness: 0.1,
                transparent: true,
                opacity: 0 // Hidden until upload
            });

            // We use the same material for front and back so the logo is visible from both sides if spinning
            const frontMat = new THREE.MeshStandardMaterial({ 
                color: 0xffffff, 
                transparent: true, 
                opacity: 0,
                alphaTest: 0.05 // Crucial for transparency!
            });
            
            const plaqueMaterials = [
                sideMat, sideMat, sideMat, sideMat, frontMat, frontMat
            ];
            
            logoPlaque = new THREE.Mesh(plaqueGeo, plaqueMaterials);
            logoGroup.add(logoPlaque);

            logoGroup.position.set(0, 0, -40);
            scene.add(logoGroup);
        };

        const animate = () => {
            requestAnimationFrame(animate);
            const time = clock.getElapsedTime();
            const duration = 15;
            const progress = (time % duration) / duration;
            
            let targetPos = new THREE.Vector3();
            let lookTarget = new THREE.Vector3();

            if (progress < 0.4) {
                const t = progress / 0.4;
                targetPos.set(8 * (1-t), 4, 18 - (10 * t));
                lookTarget.set(0, 0, 10); 
            } else if (progress < 0.8) {
                const t = (progress - 0.4) / 0.4;
                targetPos.set(Math.sin(time * 2) * 2, 1 + Math.cos(time) * 0.5, 5 - (35 * t));
                lookTarget.set(0, 0, targetPos.z - 10);
            } else {
                const t = (progress - 0.8) / 0.2;
                targetPos.set(0, 1.5, -30 - (5 * (1-t)));
                lookTarget.set(0, 0, -40);
            }

            camera.position.lerp(targetPos, 0.1);
            camera.lookAt(lookTarget);

            if(productMesh && productMesh.material.opacity > 0) {
                productMesh.rotation.z = Math.sin(time * 0.2) * 0.05;
            }
            
            if(logoGroup) {
                logoGroup.position.y = 1.5 + Math.sin(time * 1.5) * 0.2;
                logoGroup.rotation.y = Math.sin(time * 0.5) * 0.15;
            }

            foodItems.forEach((food, i) => {
                food.rotation.x += food.userData.rotSpeed;
                food.rotation.y += food.userData.rotSpeed;
                food.position.y += Math.sin(time + i) * 0.005;
            });

            if (rimLight) rimLight.position.z = camera.position.z - 5;
            renderer.render(scene, camera);
        };

        const setLighting = (type) => {
            if(type === 'warm') {
                mainLight.color.set(0xffd1a3);
                rimLight.color.set(0xffaa00);
                scene.background.set(0x1a0f08);
                scene.fog.color.set(0x1a0f08);
            } else {
                mainLight.color.set(0xffffff);
                rimLight.color.set(0x2ecc71);
                scene.background.set(0x0a0a0a);
                scene.fog.color.set(0x0a0a0a);
            }
        };

        const onWindowResize = () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        };

        const bindFileListeners = () => {
            handleFileUpload('logoUpload', logoPlaque);
            handleFileUpload('productUpload', productMesh);
        };

        const handleFileUpload = (inputId, mesh) => {
            const input = document.getElementById(inputId);
            if (!input) return;

            input.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        new THREE.TextureLoader().load(event.target.result, (tex) => {
                            if (mesh) {
                                if (tex.encoding !== undefined) {
                                    tex.encoding = THREE.sRGBEncoding;
                                } else {
                                    tex.colorSpace = THREE.SRGBColorSpace;
                                }
                                tex.needsUpdate = true;

                                if (Array.isArray(mesh.material)) {
                                    // For the 3D Logo (Box)
                                    // Update front (4) and back (5)
                                    mesh.material[4].map = tex;
                                    mesh.material[4].opacity = 1;
                                    mesh.material[4].needsUpdate = true;
                                    
                                    mesh.material[5].map = tex;
                                    mesh.material[5].opacity = 1;
                                    mesh.material[5].needsUpdate = true;

                                    // Reveal the sides now that we have a logo
                                    mesh.material[0].opacity = 1; 
                                } else {
                                    // For the Product (Plane)
                                    mesh.material.map = tex;
                                    mesh.material.opacity = 1;
                                    mesh.material.needsUpdate = true;
                                }
                                
                                const ratio = tex.image.width / tex.image.height;
                                if(inputId === 'logoUpload') {
                                    mesh.scale.set(ratio > 1.6 ? 1 : ratio/1.6, ratio > 1.6 ? 1.6/ratio : 1, 1);
                                } else {
                                    mesh.scale.set(ratio > 1 ? 1 : ratio, ratio > 1 ? 1/ratio : 1, 1);
                                }
                            }
                        });
                    };
                    reader.readAsDataURL(file);
                }
            });
        };

        const recordBtn = document.getElementById('recordBtn');
        const recordingStatus = document.getElementById('recordingStatus');
        let isRecording = false;

        recordBtn.addEventListener('click', () => {
            if (!isRecording) startRecording();
            else stopRecording();
        });

        const startRecording = () => {
            recordedChunks = [];
            const stream = renderer.domElement.captureStream(60);
            mediaRecorder = new MediaRecorder(stream, {
                mimeType: 'video/webm;codecs=vp9',
                videoBitsPerSecond: 12000000
            });
            mediaRecorder.ondataavailable = (e) => e.data.size > 0 && recordedChunks.push(e.data);
            mediaRecorder.onstop = () => {
                const blob = new Blob(recordedChunks, { type: 'video/webm' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'gourmet-intro.webm';
                a.click();
            };
            mediaRecorder.start();
            isRecording = true;
            recordBtn.innerText = "STOP RECORDING";
            recordingStatus.classList.remove('hidden');
        };

        const stopRecording = () => {
            mediaRecorder.stop();
            isRecording = false;
            recordBtn.innerText = "Download Video";
            recordingStatus.classList.add('hidden');
        };

        window.onload = init;
    </script>
</body>
</html>
